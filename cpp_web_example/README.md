# Physiology Preprocessing C++ Web Example App
## Build Instructions
### x86_64 / amd64 (most Linux & MacOS machines, not tested on Windows)

1. Ensure you have read and followed the [dependency setup instructions](/docs/dependencies/README.md).
2. Install the Mozilla CA Certificate Store.
   - Linux:
       ```bash
       sudo apt install -y ca-certificates
       ```
   - MacOS:
       ```zsh
       brew install ca-certificates
       ```

2. These instructions assume you are building from terminal and are not using CLion, Android Studio, or VSCode to compile the project -- make adjustments according to the tools you use. Also, if needed, adjust the `--output_user_root` or other [Bazel startup physiology_core_process_options](https://bazel.build/reference/command-line-reference#startup-options) to accommodate your specific environment.
   - **Developer Note**: pass in `--define='WITH_VIDEO_OUTPUT=1'` after `bazel build` if you need the video output for debugging.
    ```bash
      bazel build --copt=-O3 //applications/cpp_web_example
    ```
   When building on Mac, this version of MediaPipe doesn't support GLES, so the CPU-only version should be built. Note the extra arguments to the `build` command.
    ```bash
    bazel build --copt=-O3 --define MEDIAPIPE_DISABLE_GPU=1 --spawn_strategy=standalone //applications/cpp_web_example
    ```
   Note: an alternative way to pass the `MEDIAPIPE_DISABLE_GPU=1` definition to the compiler, e.g. when building on Mac using Clion + Bazel Plugin, is to add the following line to .bashrc in the root of the repository:  `build:macos --define='MEDIAPIPE_DISABLE_GPU=1'`

#### arm64 (Raspberry PI, etc.)
For this build, the following are required:
- An arm64 running Debian Bullseye or derivative system, e.g. Raspberry PI 4 running Raspberry PI OS 64 bit (Bullseye)
- A build machine with x86_64 architecture running docker for cross-compiling the code
- Some way to transfer files from your build machine to your arm64 system, e.g. a [samba](https://www.samba.org/) share.

Follow these steps:

1. Ensure you have a compatible OS on your arm64 device, i.e. run `lsb_release -a`. The output should read:
   ```
   Distributor ID:	Debian
   Description:	Debian GNU/Linux 12 (bookworm)
   Release:	12
   Codename:	bookworm
   ```
2. On your arm64 device, install the OpenCV libraries:
   ```bash
   sudo apt install libopencv-dev
   ```
3. On your build machine, run `./crosscompile_arm64.sh docker` in terminal. This will drop you into the docker bash of the build environment.
4. From that very shell, run `./crosscompile_arm64.sh build cpp_web_example` to launch the build. If you leave the docker shell running, you may rerun the same command for future incremental builds.
5. Transfer the built binary and resource files from `out/aarch64` folder (that will be generated by the build in the root of the repository) to your arm64 device.

Note: the docker build relies on third-party resources being in their default locations. For instance, if you're using a custom build of OpenCV and have modified WORKSPACE to use, e.g., `usr/local` instead of `usr` as the OpenCV dependency prefix, you'll want to change that back to the default before the cross-compilation.

## Usage Instructions
Caution: this and other applications so far have tested only on the following cameras.

- Logitech C920c
- Logitech C920e
- E-Con See3CAM CU27
- E-Con See3CAM CU30

1. To run directly using built binary, from root of repository, invoke:
   ```shell 
   bazel-bin/applications/cpp_web_example/cpp_web_example <args>`
   ```
   - **Note**: to understand the command line physiology_core_process_options, either consult the [Command Line Reference](/docs/command_line_reference.md) or run the program with ` --help=main`.

2. You will see the input status being printed to standard output any time the status changes.
Make the necessary adjustments to get the "No issues" status (code 0), then hit `s` to start recording.

During the run, enjoy the following keyboard shortcuts:
- `q` or `ESC`: exit
- `s`: start/stop recording data (**webcam input / streaming** mode only)
- `e`: lock/unlock exposure (**webcam input / streaming** mode only)
- `-` and `=`: decrease or increase exposure (**webcam input / streaming** mode only, and only when exposure is locked)