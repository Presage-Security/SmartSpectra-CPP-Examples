# Physiology Preprocessing C++ gRPC Example App

## Build Instructions

### AMD64/x86_64/x64
1. Ensure you have read and followed the [dependency setup instructions](/docs/dependencies/README.md).
2. Launch the build (but consult notes below first!):
   - **Linux**
       ```bash
       bazel build --copt=-O3 //applications/cpp_grpc_example:cpp_grpc_example
       ```
   - **MacOS**
       ```bash
       bazel build --copt=-O3 --define MEDIAPIPE_DISABLE_GPU=1 //applications/cpp_grpc_example:cpp_grpc_example
       ```
   - Explanation: when building on Mac, MediaPipe doesn't support GLES, so the CPU-only version should be built.
   - **Developer Note**: pass in `--define='WITH_VIDEO_OUTPUT=1'` after `bazel build` if you need the video output for debugging.

### ARM64 via Docker

1. On your arm64 device, compile OpenCV 4.2. A convenient script for debian-based ARM64 systems is provided for this at [OpenCV-4-2-0.sh](/build0.sh), you may choose to transfer it over to your device and run it from the shell. Alternatively, cross-compile OpenCV 4.2 and transfer it to your device.
2. On your build machine, run `crosscompile_arm64.sh docker` in terminal. This will drop you into the docker bash of the build environment.
3. From that very shell, run `crosscompile_arm64.sh build cpp_grpc_example` to launch the build. If you leave the docker shell running, you may rerun the same command for future incremental builds.
4. Transfer the built binary and resource files from `<repo_root>/out/aarch64` folder (that will be generated by the build in the root of the repository) to your device.

## Run Instructions with Dummy Server (this repo only)

First, launch the test server generating random HR and RR values:

`bazel run //applications/cpp_grpc_example:dummy_physiology_core_grpc_server`

Then, launch the client itself. You can do this by directly executing the binary from repo root:

`bazel-bin/applications/cpp_grpc_example/cpp_grpc_example --also_log_to_stderr`

You will see the status code being printed to stdout any time the status changes.

**Note**: to understand the command line physiology_core_process_options, either consult the [Command Line Reference](/docs/command_line_reference.md) or run the program with:
Make the necessary adjustments to get a `0` status code, then hit `s` to start recording.

The gRPC calculator used in this application caches preprocessed data at fixed intervals and then performs the gRPC call with the entire batch of buffered data. 
 - **Note**: the buffering interval duration is controlled by passing `--buffer_duration=X` parameter, where `X` is a real number signifying duration in **seconds**. For example,  
   ```shell
   bazel-bin/applications/cpp_grpc_example/cpp_grpc_example --also_log_to_stderr --buffer_duration=0.5
   ```

will issue gRPC calls at intervals of 5 seconds.

## Run Instructions with Demo Physiology Server (this repo + Physiology Core)

1. Check out the [Physiology Core repository](https://source.presagesecurity.com/presage/developers/presage_physiology).
2. From that repo's root, launch the gRPC demo server on port 50052: 
   ```shell
   python grpc_core_server.py --port=50052
   ```
   Note: pass the `--headless` flag to the above script to run the server without the GUI / real-time charting
3. In a separate terminal, launch binary from the current repo root (adjust `buffer_duration` as desired): 
   ```shell
   bazel-bin/applications/cpp_grpc_example/cpp_grpc_example --also_log_to_stderr --buffer_duration=5 --core_port=50052`
   ```
4. You will see the input status being printed to standard output any time the status changes.
   Make the necessary adjustments to get the "No issues" status (code 0), then hit `s` to start recording. 

5. Hit `s` to start recording. The metrics output should start showing in ~10-15 seconds.

During the run, enjoy the following keyboard shortcuts:
- `q` or `ESC`: exit
- `s`: start/stop recording data (**webcam input / streaming** mode only)
- `e`: lock/unlock exposure (**webcam input / streaming** mode only)
- `-` and `=`: decrease or increase exposure (**webcam input / streaming** mode only, and only when exposure is locked)
